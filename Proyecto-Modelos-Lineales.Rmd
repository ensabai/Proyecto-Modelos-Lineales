---
title: "Proyecto"
author: Carlos Gila Blanco y Enrique Sayas Bailach
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  html_notebook:
    echo: yes
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: 3
params:
  lang: ES
lang: r switch(params$lang, ES = 'es-ES', EN = 'en-US')
subtitle: Tratamiento de Datos. Grado en Ciencia de Datos- UV
language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
---

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}
# Configuración del los bloques (*Chunks*)

# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

# Opciones generales de los chucks. Se utilizarán salvo cambios en el chunk
opts_chunk$set(echo=T, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

# Opciones generales de dígitos cuando se incluyen tablas
#options(xtable.type = 'html')
knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})
#knit_hooks$set(plot = knitr:::hook_plot_html)
```

```{r echo = F, message = F}
# Instalación automática de paquetes

# Especificamos las librerías necesarias en esta lista

packages = c("readr","ggplot2","dplyr","tidyr","stringr","GGally","car")

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#verify they are loaded
search()
rm(list = ls())
```

# Introducción al trabajo

## Carga del banco de datos

```{r}
music_genre <- read_csv("data/music_genre.csv")
summary(music_genre)
```

## Adecuación tipo de datos

```{r}
music_genre <- music_genre %>% filter(!is.na(popularity))
music_genre$instance_id <- as.character(music_genre$instance_id)
music_genre$key <- as.factor(music_genre$key)
music_genre$mode <- as.factor(music_genre$mode)
music_genre$tempo[music_genre$tempo == "?"] = NA
music_genre$tempo <- as.numeric(music_genre$tempo)
music_genre$loudness <- music_genre$loudness - min(music_genre$loudness, na.rm = TRUE)
music_genre$music_genre <- as.factor(music_genre$music_genre)
summary(music_genre)
table(music_genre$music_genre)
```

## Ejemplo gráfico

```{r}
music_genre1 <- music_genre %>% select(-c(key,mode,obtained_date))
music_genre1 <- music_genre1 %>% mutate(popularity_por = popularity / 100,
                        duration_por = duration_ms / max(duration_ms, na.rm = TRUE),
                        tempo_por = tempo / max(tempo, na.rm = TRUE),
                        loudness_por = loudness / max(loudness, na.rm = TRUE)
                        )

music_genre1 %>% filter(instance_id %in% c(49721, 66116, 20548)) %>% 
  pivot_longer(-c(instance_id,artist_name,track_name,popularity,duration_ms,music_genre,tempo,loudness),names_to = "categorias", values_to = "valores") %>% 
  ggplot(aes(x = categorias, y = valores, group = instance_id, fill = instance_id)) +
  geom_col(color = "black") + coord_polar() + theme_minimal() +
  theme(axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank())
```

```{r}
music_genre2 <- music_genre1 %>% group_by(music_genre) %>% 
  summarise(acousticness  = mean(acousticness), danceability = mean(danceability), energy = mean(energy), instrumentalness = mean(instrumentalness), liveness = mean(liveness), speechiness = mean(speechiness), valence = mean(valence), popularity = mean(popularity_por), duration = mean(duration_por), tempo = mean(tempo_por, na.rm = TRUE), loudness = mean(loudness_por))

generos <- c("Alternative","Anime","Blues","Classical","Country","Electronic","Hip-Hop","Jazz","Rap","Rock")

valores <- c("#006633", "#FFC0CB", "#000080", "#000000", "#D2B48C", "#00FFFF", "#FF0000", "#ADD8E6", "#808080", "#8B0000")

music_genre2 %>% filter(music_genre %in% c("Anime","Rock","Blues")) %>% 
  pivot_longer(-c(music_genre),names_to = "categorias", values_to = "valores") %>% 
  ggplot(aes(x = categorias, y = valores, group = music_genre, fill = music_genre)) +
  geom_col(color = "black") + 
  coord_polar() + 
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_manual(
    values = valores,
    breaks = generos
  ) + facet_wrap(vars(music_genre))
```





